# Phase 2: Unified Environment Variable Access

## Prerequisites

- Phase 1 must be complete:
  - Files renamed to `.env.config` and `.env.secrets`
  - 1Password items tagged with `BF_PUBLIC_CONFIG` and `BF_PRIVATE_SECRET`
  - `bft secrets sync` supports tag-based querying
  - Type generation still works (writes to `/env.d.ts`)

## Implementation Plan

### Step 1: Build Infrastructure

1. Create `packages/env/inject.ts` with `injectEnvironment` function
2. Update type generation to support `ImportMetaEnv`
3. Add build-time validation

### Step 2: Update Type Definitions

1. Update `/env.d.ts` to support runtime injection:

```typescript
// /env.d.ts - Still generated by bft secrets sync
// Keep existing structure but update ImportMeta definition
declare interface ImportMeta {
  env?: ImportMetaEnv; // Make optional to allow injection
}

// Add window.__ENVIRONMENT__ type
declare interface Window {
  __ENVIRONMENT__?: ClientEnvVars; // Only client-safe vars
}
```

### Step 3: Implement Core Function with Tests

1. Write tests first:

```typescript
// __tests__/inject.test.ts
Deno.test("injectEnvironment - browser environment", () => {
  // Mock browser environment
  const mockWindow = { __ENVIRONMENT__: { POSTHOG_API_KEY: "test-key" } };
  globalThis.window = mockWindow as any;

  const meta = {} as ImportMeta;
  injectEnvironment(meta);
  assertEquals(meta.env?.POSTHOG_API_KEY, "test-key");

  // Cleanup
  delete (globalThis as any).window;
});

Deno.test("injectEnvironment - server environment", () => {
  const meta = {} as ImportMeta;
  injectEnvironment(meta);
  // Should have access to all env vars from Deno.env
  assertExists(meta.env);
});
```

2. Implement to pass tests:

```typescript
// Usage: Call at top of file after imports
// import { injectEnvironment } from "@bfmono/env";
// injectEnvironment(import.meta);

export function injectEnvironment(meta: ImportMeta): void {
  // Initialize env if not present
  if (!meta.env) {
    meta.env = {} as ImportMetaEnv;
  }

  // Browser environment
  if (typeof window !== "undefined" && window.__ENVIRONMENT__) {
    Object.assign(meta.env, window.__ENVIRONMENT__);
    return;
  }

  // Server environment - Deno has already loaded .env files
  if (typeof Deno !== "undefined") {
    const allEnvVars = Deno.env.toObject();
    Object.assign(meta.env, allEnvVars);

    // Add computed properties
    meta.env.MODE = allEnvVars.NODE_ENV || allEnvVars.DENO_ENV || "development";
    meta.env.PROD = meta.env.MODE === "production";
    meta.env.DEV = meta.env.MODE !== "production";
    meta.env.SSR = true;
    meta.env.BASE_URL = allEnvVars.BASE_URL || "/";
  }
}
```

### Step 4: Update Browser Environment Injection

1. Update all apps that use `globalThis.__ENVIRONMENT__` to use
   `window.__ENVIRONMENT__`:
   - Keep using `getConfigurationVariable` for now (backwards compatibility)
   - Ensure only client-safe variables are included
   - Remove the existing Vite plugin that does build-time replacement

2. Update Vite configuration:
   - Remove the env plugin that uses `define` for replacements
   - Ensure Vite doesn't process `import.meta.env` (we handle it at runtime)

3. Usage pattern:
   ```typescript
   import { injectEnvironment } from "@bfmono/packages/env/inject.ts";
   injectEnvironment(import.meta);

   // Now import.meta.env is populated
   const apiKey = import.meta.env.POSTHOG_API_KEY;
   ```

## Files to Create/Update

- `/packages/env/inject.ts` - Core injection logic
- `/env.d.ts` - Update type definitions to support injection
- `/packages/env/__tests__/inject.test.ts` - Tests for injection system
- `/packages/env/vite-plugin.ts` - Remove or update to not use `define`
- All app entry points - Add `injectEnvironment(import.meta)` calls
- Update apps using `globalThis.__ENVIRONMENT__` to use `window.__ENVIRONMENT__`

## Verification Checklist

- [ ] `injectEnvironment` function created and working
- [ ] `/env.d.ts` updated to allow runtime injection
- [ ] Vite plugin updated to not interfere with runtime injection
- [ ] `import.meta.env` provides type-safe access after injection
- [ ] Tests pass for both browser and server environments
- [ ] Apps updated to use `window.__ENVIRONMENT__` instead of
      `globalThis.__ENVIRONMENT__`
- [ ] Backwards compatibility maintained - `getConfigurationVariable` still
      works
- [ ] At least one app successfully using the new injection pattern
